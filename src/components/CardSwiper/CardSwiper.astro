---
import Card from "./Card.astro";

const itemsPlaceholder = [
  {
  title: "Test Item",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/avel-chuklanov-ZEiqbaQhmvE-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
  {
  title: "Test Item 2",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/stock-zahra-q_zVt9iTazQ-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 3",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/stock-zahra-q_zVt9iTazQ-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 4",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/avel-chuklanov-ZEiqbaQhmvE-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 5",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/stock-zahra-q_zVt9iTazQ-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 6",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/avel-chuklanov-ZEiqbaQhmvE-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 7",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/avel-chuklanov-ZEiqbaQhmvE-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 8",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/avel-chuklanov-ZEiqbaQhmvE-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
    {
  title: "Test Item 9",
  description: "padapodpaodapodpaodpaodapoda",
  image: {
    src: "/src/assets/avel-chuklanov-ZEiqbaQhmvE-unsplash.jpg",
    alt: "Military aircraft in flight",
  },
  targetsWhere: "/"
  },
]

const swiperDataPlaceholder = {
  title: "This Swiper Title",
  upperHeader: "Yeah Something",
  paragraphs: [
    ""
  ]
}

const { swiperData = swiperDataPlaceholder, items = itemsPlaceholder } = Astro.props;
const allItems = [...items, ...items, ...items];
---

<div class="relative w-full p-4">
      <div class="max-w-7xl mx-auto flex flex-col space-y-4">
      <p class="mx-auto subtitle !text-black">{swiperData.upperHeader}</p>
      <h2 class="text-4xl md:text-5xl max-w-3xl mx-auto font-bold text-center title">
        {swiperData.title}
      </h2>
      {
        swiperData.paragraphs.map((paragraph:string)=>(
        <p class="text-xl text-center sans max-w-2xl mx-auto">
        {paragraph}
      </p>))
      }
    </div>
  <div class="swiper-container overflow-hidden">
    <div class="swiper-wrapper flex transition-transform duration-500">
      {allItems.map((item, idx) => (
        <div class="swiper-slide flex-shrink-0 w-full lg:w-1/3 px-2">
          <Card
            title={item.title}
            description={item.description}
            image={item.image}
            targetWhere={item.targetWhere}
            showControls={true}
            targetsWhere={item.targetsWhere}
          />
        </div>
      ))}
    </div>
  </div>
  
  <div class="swiper-dots flex justify-center gap-2 mt-4">
    {items.map((_, i) => (
      <button class="dot w-2 h-2 rounded-full bg-gray-400 transition-all" data-index={i}></button>
    ))}
  </div>
</div>

<script>
  const container = document.querySelector('.swiper-wrapper');
  const dots = document.querySelectorAll('.dot');
  const slides = document.querySelectorAll('.swiper-slide');
  
  const realTotal = dots.length;
  let current = realTotal;
  
  function getSlidesPerView() {
    return window.innerWidth >= 1024 ? 3 : 1;
  }
  
  function getMiddleOffset() {
    return window.innerWidth >= 1024 ? 1 : 0;
  }
  
  function updateSwiper(animate = true) {
    const slidesPerView = getSlidesPerView();
    const percentage = 100 / slidesPerView;
    
    if (!animate) {
      container.style.transition = 'none';
    }
    container.style.transform = `translateX(-${current * percentage}%)`;
    if (!animate) {
      container.offsetHeight;
      container.style.transition = '';
    }
    
    const dotIndex = current % realTotal;
    dots.forEach((d, i) => {
      d.classList.toggle('bg-white', i === dotIndex);
      d.classList.toggle('bg-gray-400', i !== dotIndex);
      d.classList.toggle('w-6', i === dotIndex);
      d.classList.toggle('w-2', i !== dotIndex);
    });
    
    const middleOffset = getMiddleOffset();
    slides.forEach((slide, idx) => {
      const card = slide.querySelector('.group');
      const prevBtn = card.querySelector('.swiper-prev');
      const nextBtn = card.querySelector('.swiper-next');
      
      if (idx === current + middleOffset) {
        if (prevBtn) prevBtn.style.display = 'block';
        if (nextBtn) nextBtn.style.display = 'block';
      } else {
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
      }
    });
  }
  
  function next() {
    current++;
    updateSwiper(true);
    
    if (current >= realTotal * 2) {
      setTimeout(() => {
        current = realTotal;
        updateSwiper(false);
      }, 500);
    }
  }
  
  function prev() {
    current--;
    updateSwiper(true);
    
    if (current < realTotal) {
      setTimeout(() => {
        current = realTotal * 2 - 1;
        updateSwiper(false);
      }, 500);
    }
  }
  
  document.addEventListener('click', (e) => {
    if (e.target.closest('.swiper-prev')) {
      e.preventDefault();
      prev();
    } else if (e.target.closest('.swiper-next')) {
      e.preventDefault();
      next();
    }
  });
  
  dots.forEach((d, i) => {
    d.addEventListener('click', () => {
      current = realTotal + i;
      updateSwiper(true);
    });
  });
  
  let interval = setInterval(next, 3000);
  
  document.querySelector('.swiper-container').addEventListener('mouseenter', () => {
    clearInterval(interval);
  });
  
  document.querySelector('.swiper-container').addEventListener('mouseleave', () => {
    interval = setInterval(next, 3000);
  });
  
  window.addEventListener('resize', () => {
    updateSwiper(false);
  });
  
  updateSwiper(false);
</script>