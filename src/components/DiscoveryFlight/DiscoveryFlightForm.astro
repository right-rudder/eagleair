---
const FORM_WEBHOOK_URL = import.meta.env.DISCOVERY_FLIGHT_FORM_WEBHOOK_URL;
const PORTAL_API_KEY = import.meta.env.PORTAL_API_KEY;
const CP_ACCOUNT_RANDOM_ID = import.meta.env.CP_ACCOUNT_RANDOM_ID;
const FLIGHT_TIMES = [
  "08:00 AM",
  "10:00 AM",
  "12:00 PM",
  "02:00 PM",
  "04:00 PM",
];
---

<form class="mx-auto max-w-xl flex flex-col" id="enroll_form">
  <input type="hidden" name="program_interest" value="Discovery Flight" />

  <div class="grid grid-cols-1 gap-x-8 gap-y-2 sm:grid-cols-2">
    <div>
      <div class="mt-2.5">
        <input
          type="text"
          name="first-name"
          id="first-name"
          autocomplete="given-name"
          placeholder="First Name"
          required
          class="block p-2 focus:ring-2 focus:rounded focus:ring-inset focus:ring-black w-full border-b-[1px] border-gray-300 bg-white py-2 text-gray-900 shadow-sm ring-sky-600 outline-none ring-inset placeholder:text-gray-500 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div>
      <div class="mt-2.5">
        <input
          type="text"
          name="last-name"
          id="last-name"
          autocomplete="family-name"
          placeholder="Last Name"
          required
          class="block p-2 w-full focus:ring-2 focus:rounded focus:ring-inset focus:ring-black border-b-[1px] border-gray-300 bg-white py-2 text-gray-900 shadow-sm ring-sky-600 outline-none ring-inset placeholder:text-gray-500 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div class="sm:col-span-2">
      <div class="mt-2.5">
        <input
          type="email"
          name="email"
          id="email"
          autocomplete="email"
          placeholder="Email Address"
          required
          class="block focus:ring-2 focus:rounded focus:ring-inset focus:ring-black  p-2 w-full border-b-[1px] border-gray-300 bg-white py-2 text-gray-900 shadow-sm ring-sky-600 outline-none ring-inset placeholder:text-gray-500 sm:text-sm sm:leading-6"
        />
      </div>
    </div>
    <p class="hidden">
      <label>
        Don't fill this out if you're human: <input name="confirm-email" />
      </label>
    </p>

    <div class="sm:col-span-2">
      <div class="relative mt-2.5">
        <input
          type="tel"
          name="phone"
          id="phone"
          autocomplete="tel"
          placeholder="Phone Number"
          required
          class="bloc focus:ring-2 focus:rounded focus:ring-inset focus:ring-black p-2 w-full border-b-[1px] border-gray-300 bg-white py-2 text-gray-900 shadow-sm ring-sky-600 outline-none ring-inset placeholder:text-gray-500 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div class="sm:col-span-1">
        <div class="mt-2.5 ">
          <input
            type="date"
            name="requested_date"
            id="requested_date"
            required
            class="block focus:ring-2 focus:rounded focus:ring-inset focus:ring-black w-full border-b-[1px] border-gray-300 bg-white px-4 py-2 text-gray-500 shadow-sm ring-sky-600 outline-none ring-inset placeholder:text-gray-500 sm:text-sm sm:leading-6"
          />
        </div>
    </div>

    <div class="sm:col-span-1">
        <div class="mt-2.5">
            <select
            name="requested_time"
            id="requested_time"
            required
            class="block focus:ring-2 focus:rounded focus:ring-inset focus:ring-black w-full hover:cursor-pointer  bg-white border-0 text-gray-500  px-4 py-2 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6"
            >
            <option value="" disabled selected>
                Preferred Time
            </option>
            {FLIGHT_TIMES.map((time) => (
                <option value={time}>{time}</option>
            ))}
            </select>
        </div>
    </div>

    <div class="sm:col-span-2">
      <div class="mt-2.5">
        <textarea
          name="notes"
          id="notes"
          rows="4"
          placeholder="How can we help? (Special requests, passenger weight details, etc.)"
          class="block focus:ring-2 focus:rounded focus:ring-inset focus:ring-black p-2 w-full border-b-[1px] border-gray-300 bg-white py-2 text-gray-900 shadow-sm ring-sky-600 outline-none ring-inset placeholder:text-gray-500 sm:text-sm sm:leading-6"
        ></textarea>
      </div>
    </div>

    <div class="flex gap-x-4 sm:col-span-2 text-white">
      <div class="flex h-6 items-center">
        <button
          type="button"
          id="terms-toggle"
          class="ring-primary-900/5 flex w-8 flex-none cursor-pointer bg-gray-200 p-px ring-1 transition-colors duration-200 ease-in-out ring-inset focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-900"
          role="switch"
          aria-checked="false"
          aria-labelledby="switch-1-label"
        >
          <span class="sr-only text-white">
            I agree to terms & conditions provided by the company.
          </span>
          <span
            id="terms-thumb"
            class="h-4 w-4 translate-x-0 transform bg-white shadow-sm ring-1 ring-gray-900/50 transition duration-200 ease-in-out"
            aria-hidden="true"></span>
        </button>
        <input type="hidden" id="agree-terms" name="agree-terms" value="no" />
      </div>
      <label class="text-sm leading-6 text-black sans" id="switch-1-label">
        I agree to the <a
          href="/privacy-policy-terms-of-service"
          target="_blank"
          class="text-primary-700 hover:text-picton-blue-400 font-semibold hover:underline"
          >Privacy Policy</a
        > and <a
          href="/privacy-policy-terms-of-service#terms-of-service"
          target="_blank"
          class="text-primary-700 hover:text-picton-blue-400 font-semibold hover:underline"
          >Terms of Service</a
        > provided by the company. By providing my phone number, I agree to receive
        text notes from the business.
      </label>
    </div>
  </div>
  <div class="mt-10">
    <button type="submit" id="submit-btn" class="btn-tertiary-red">Request Flight</button>
  </div>
</form>

<script define:vars={{ FORM_WEBHOOK_URL, PORTAL_API_KEY, CP_ACCOUNT_RANDOM_ID }}
>
  const toggle = document.getElementById("terms-toggle");
  const thumb = document.getElementById("terms-thumb");
  const hiddenInput = document.getElementById("agree-terms");
  const submitBtn = document.getElementById("submit-btn");
  const form = document.getElementById("enroll_form");
  const dateInput = document.getElementById("requested_date");

  // --- Date Logic Setup ---
  // 1. Calculate min date (Today + 3 days)
  const today = new Date();
  const minDate = new Date();
  minDate.setDate(today.getDate() + 3);

  // Format YYYY-MM-DD for the input attribute
  const yyyy = minDate.getFullYear();
  const mm = String(minDate.getMonth() + 1).padStart(2, '0');
  const dd = String(minDate.getDate()).padStart(2, '0');
  const minDateString = `${yyyy}-${mm}-${dd}`;
  
  if(dateInput) {
      dateInput.setAttribute("min", minDateString);
      
      // 2. Event Listener to check "Days they work"
      dateInput.addEventListener("input", function(e) {
          const selectedDate = new Date(this.value);
          // getDay(): 0 = Sunday, 1 = Monday, ... 6 = Saturday
          const dayOfWeek = selectedDate.getUTCDay(); 

          // CONFIG: Array of allowed days (0-6). 
          // Example: [1, 2, 3, 4, 5, 6] would exclude Sundays.
          // Currently set to allow all days (0-6) as flight schools often work weekends.
          // If you need to close Sundays, remove '0' from this array.
          const ALLOWED_DAYS = [0, 1, 2, 3, 4, 5, 6]; 

          if (!ALLOWED_DAYS.includes(dayOfWeek)) {
              alert("Sorry, we are not open on this day. Please select another date.");
              this.value = ""; // Clear the invalid selection
          }
      });
  }
  // ------------------------

  let isChecked = false;
  const SUBMIT_COOLDOWN = 30 * 1000; // 30 seconds

  // Terms toggle
  toggle.addEventListener("click", () => {
    isChecked = !isChecked;
    hiddenInput.value = isChecked ? "yes" : "no";
    toggle.setAttribute("aria-checked", isChecked);
    toggle.classList.toggle("bg-monza-700", isChecked);
    toggle.classList.toggle("bg-gray-200", !isChecked);
    thumb.classList.toggle("translate-x-3.5", isChecked);
    thumb.classList.toggle("translate-x-0", !isChecked);

    submitBtn.disabled = !isChecked;
    submitBtn.classList.toggle("cursor-not-allowed", !isChecked);
    submitBtn.classList.toggle("bg-gray-400", !isChecked);
  });

  // Initialize submit button
  submitBtn.disabled = true;
  submitBtn.classList.add("cursor-not-allowed", "bg-gray-400");

  if (!form) {
    console.error("Form element not found.");
  } else {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      // Honeypot check
      const formData = new FormData(form);
      if (formData.get("confirm-email")?.trim()) return;

      // Cooldown using localStorage
      const lastSubmit = parseInt(
        localStorage.getItem("lastSubmit") || "0",
        10,
      );
      const now = Date.now();
      if (now - lastSubmit < SUBMIT_COOLDOWN) {
        alert("Please wait a few seconds before submitting again.");
        return;
      }
      localStorage.setItem("lastSubmit", now.toString());

      // Format date to MM-DD-YYYY for American standards
      const rawDate = formData.get("requested_date");
      if (rawDate) {
        const [year, month, day] = rawDate.toString().split("-");
        const americanDate = `${month}-${day}-${year}`;
        formData.set("requested_date", americanDate);
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.classList.add("cursor-not-allowed", "bg-gray-400");
      submitBtn.innerText = "Sending...";

      try {
        const [ghlRes, portalRes] = await Promise.all([
          // Webhook (Usually flexible with new fields like requested_date)
          fetch(FORM_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams(formData).toString(),
          }),
          // Portal API (Strict schema)
          fetch("https://portal.rightruddermarketing.com/api/leads", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              "x-api-key": PORTAL_API_KEY,
            },
            body: JSON.stringify({
              first_name: formData.get("first-name")?.toString() || "",
              last_name: formData.get("last-name")?.toString() || "",
              email: formData.get("email")?.toString() || "",
              phone: formData.get("phone")?.toString() || "",
              campaign: "contact",
              account_random_id: CP_ACCOUNT_RANDOM_ID,
              note: formData.get("notes")?.toString() || ""
            }),
          }),
        ]);

        if (ghlRes.ok && portalRes.ok) {
          window.location.href = "/contact-confirmation";
        } else {
          alert("Submission failed. Please try again later.");
          submitBtn.disabled = false;
          submitBtn.classList.remove("cursor-not-allowed", "bg-gray-400");
          submitBtn.innerText = "Request Flight";
        }
      } catch (err) {
        console.error("Submission error:", err);
        alert("An error occurred. Please try again later.");
        submitBtn.disabled = false;
        submitBtn.classList.remove("cursor-not-allowed", "bg-gray-400");
        submitBtn.innerText = "Request Flight";
      }
    });
  }
</script>
<style>
  input[type="date"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
  }

  select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  background-size: 1.5em 1.5em;
}
</style>